<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Relatório Gerencial</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body{padding:20px;background:#f8f9fa;font-family:Arial,sans-serif}
    .container{background:#fff;padding:20px;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,0.1)}
    table th, table td{vertical-align:middle}
    .summary{font-weight:bold;margin-top:15px}
    canvas{margin-top:20px}
  </style>
</head>
<body>
  <div class="container">
    <header class="d-flex justify-content-between align-items-center mb-3">
      <h1>Relatório Gerencial</h1>
      <a class="btn btn-secondary" href="menu.html">← Voltar ao menu</a>
    </header>

    <div class="row g-3 mb-3">
      <div class="col-md-2"><label>Data Início<br><input type="date" id="startDate" class="form-control"></label></div>
      <div class="col-md-2"><label>Data Fim<br><input type="date" id="endDate" class="form-control"></label></div>
      <div class="col-md-3"><label>Usuários<br><select id="userSelect" multiple size="5" class="form-control"></select></label></div>
      <div class="col-md-3"><label>Tipo de Curso<br><select id="cursoFilter" class="form-select"><option value="">Todos</option><option>Oficina Musica</option><option>Yoga</option><option>Artesanato</option><option>Roda de Conversa</option><option>Psicologa</option></select></label></div>
      <div class="col-md-2 d-flex align-items-end gap-2">
        <button id="generate" class="btn btn-primary">Gerar</button>
        <button id="printBtn" class="btn btn-outline-secondary">Imprimir</button>
        <button id="exportExcel" class="btn btn-outline-success">Excel</button>
        <button id="exportPdf" class="btn btn-outline-danger">PDF</button>
      </div>
    </div>

    <div class="summary" id="summaryInfo"></div>

    <table class="table table-striped" id="reportTable">
      <thead class="table-dark">
        <tr><th>Matrícula</th><th>Nome</th><th>Tipo de Curso</th><th>Qtd Presenças</th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <canvas id="chart" height="120"></canvas>
  </div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
const data = [
  {matricula:'1001', nome:'Ana Silva', curso:'Yoga', date:'2025-01-10'},
  {matricula:'1002', nome:'Bruno Lima', curso:'Oficina Musica', date:'2025-01-12'},
  {matricula:'1003', nome:'Carla Souza', curso:'Artesanato', date:'2025-02-05'},
  {matricula:'1004', nome:'Diego Santos', curso:'Roda de Conversa', date:'2025-01-20'},
  {matricula:'1005', nome:'Elisa Fernandes', curso:'Psicologa', date:'2025-03-10'},
  {matricula:'1001', nome:'Ana Silva', curso:'Yoga', date:'2025-01-15'},
  {matricula:'1002', nome:'Bruno Lima', curso:'Oficina Musica', date:'2025-02-15'}
];

const userSelect = document.getElementById('userSelect');
const chartCanvas = document.getElementById('chart');
let chartInstance = null;

function populateUsers(){
  const uniqueUsers = [...new Map(data.map(item => [item.matricula, item])).values()];
  userSelect.innerHTML = uniqueUsers.map(u=>`<option value="${u.matricula}">${u.nome} (${u.matricula})</option>`).join('');
}

populateUsers();

function generateReport(){
  const start = new Date(document.getElementById('startDate').value);
  const end = new Date(document.getElementById('endDate').value);
  const selectedUsers = Array.from(userSelect.selectedOptions).map(o=>o.value);
  const cursoFilter = document.getElementById('cursoFilter').value;

  if(!start || !end){alert('Selecione o período'); return;}

  let filtered = data.filter(r=>{
    const d=new Date(r.date);
    return d>=start && d<=end && (selectedUsers.length===0 || selectedUsers.includes(r.matricula)) && (cursoFilter === '' || r.curso === cursoFilter);
  });

  const userCount = new Set(data.map(r=>r.matricula)).size;
  const activeCount = new Set(filtered.map(r=>r.matricula)).size;
  document.getElementById('summaryInfo').textContent = `Usuários cadastrados: ${userCount} | Ativos no período: ${activeCount}`;

  const grouped = {};
  filtered.forEach(r=>{
    const key = r.matricula+'|'+r.curso;
    if(!grouped[key]) grouped[key]={matricula:r.matricula,nome:r.nome,curso:r.curso,count:0};
    grouped[key].count++;
  });

  const tbody=document.querySelector('#reportTable tbody');
  tbody.innerHTML='';
  Object.values(grouped).forEach(item=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${item.matricula}</td><td>${item.nome}</td><td>${item.curso}</td><td>${item.count}</td>`;
    tbody.appendChild(tr);
  });

  // Chart
  const courseTotals = {};
  filtered.forEach(r=>{courseTotals[r.curso]=(courseTotals[r.curso]||0)+1;});
  const labels = Object.keys(courseTotals);
  const values = Object.values(courseTotals);

  if(chartInstance) chartInstance.destroy();
  chartInstance = new Chart(chartCanvas,{type:'bar',data:{labels, datasets:[{label:'Presenças por Curso',data:values,backgroundColor:'rgba(54,162,235,0.6)'}]}});
}

document.getElementById('generate').addEventListener('click',generateReport);

// Imprimir
document.getElementById('printBtn').addEventListener('click',()=>{window.print();});

// Export Excel
document.getElementById('exportExcel').addEventListener('click',()=>{
  const wb = XLSX.utils.book_new();
  const ws_data = [['Matrícula','Nome','Curso','Qtd Presenças'],...Array.from(document.querySelectorAll('#reportTable tbody tr')).map(tr=>Array.from(tr.children).map(td=>td.textContent))];
  const ws = XLSX.utils.aoa_to_sheet(ws_data);
  XLSX.utils.book_append_sheet(wb, ws, 'Relatorio');
  XLSX.writeFile(wb, 'relatorio.xlsx');
});

// Export PDF
document.getElementById('exportPdf').addEventListener('click',()=>{
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.text('Relatório Gerencial', 10, 10);
  doc.autoTable({ html: '#reportTable', startY: 20 });
  doc.save('relatorio.pdf');
});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</body>
</html>